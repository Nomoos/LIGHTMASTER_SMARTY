<?phpinclude '../filter/filter-filter.php';if(isset($_GET['lamp']) or isset($_POST['lamp'])) {if(!isset($_SESSION['filter']['company'])) {    go($setup['adm']['www'].'companies/list.html');}if(!isset($_POST['lat']) or !isset($_POST['lng'])){        if(isset($_GET['lamp'])){            $_POST['lamp'] = $_GET['lamp'];        }        $list_sql = query("SELECT * FROM lamp WHERE id=" . $_POST['lamp'] . ";");        $result = fetch_array($list_sql);        $lamp = $result[0];        $_POST['lampip'] = $lamp['iplamp'];        $_POST['control'] = $lamp['control_gateway_ID_control'];        $_POST['defaultPlan'] = $lamp['workload_plan_default_ID_plan'];        $_POST['plan'] = $lamp['workload_plan_ID_plan'];        $_POST['lat'] = $lamp['lat'];        $_POST['lng'] = $lamp['lng'];        $_POST['is_enabled'] = $lamp['is_enabled'];        $_POST['set_workload'] = $lamp['set_workload'];        $list_sql = query("SELECT area_ID_area FROM control_gateway WHERE ID_control=" . $_POST['control'] . ";");        $result = fetch_array($list_sql);        $_POST['area'] = $result[0]['area_ID_area'];}if ($_POST['submitValue'] == 'new') {    if (!$_POST['lat']) {        $err[] = "NOTFILLLAT";    }    if (!$_POST['lng']) {        $err[] = "NOTFILLLNG";    }    if (!$_POST['lampip']) {        $err[] = "NOTFILLIP";    }    if (!$_POST['area']) {        $err[] = "NOTFILLAREA";    }    if (!$_POST['control']) {        $err[] = "NOTFILLCONTROL";    }    if (!$_POST['defaultPlan']) {        $err[] = "NOTFILLDEFAULTPLAN";    }elseif($_POST['defaultPlan']==50){        if (!$_POST['plan']) {            $err[] = "NOTFILLPLAN";        }    }elseif($_POST['defaultPlan']==51){        if ($_POST['is_enabled']==1) {            if (!$_POST['set_workload']){                $err[] = "NOTFILLSETWORKLOAD";            }        }    }    if (!$err) {        if (!query("UPDATE lamp SET `control_gateway_ID_control`='".$_POST['control']."', `lng`='".$_POST['lng']."', `lat` = '".$_POST['lat']."', `iplamp` = '".$_POST['lampip']."',`workload_plan_default_ID_plan`='".$_POST['defaultPlan']."' WHERE `id`='".$id."';")) {            $err[] = "FAULTINDBINSERT";            $smarty->assign("err", $err);        }else {            $list_sql = query("SELECT id FROM lamp WHERE id=".$_POST['lamp']." ORDER BY id DESC  limit 1;");            $id = fetch_array($list_sql);            $id = $id[0]['id'];            if($_POST['defaultPlan']==50){                query("UPDATE lamp SET `workload_plan_ID_plan`='".$_POST['plan']."' WHERE `id`='".$id."';");            }elseif($_POST['defaultPlan']==51){                if ($_POST['is_enabled']==1) {                    query("UPDATE lamp SET `is_enabled`='1', `set_workload`='".$_POST['set_workload']."' WHERE `id`='".$id."';");                }else{                    query("UPDATE lamp SET `is_enabled`='0', `set_workload`='0' WHERE `id`='".$id."';");                }            }            go($setup['adm']['www'].'lamps/edit.html?lamp='.$id);        }    } else {        $smarty->assign("err", $err);    }}$list_sql = query("    SELECT * FROM area WHERE company_ID_company =" . $_SESSION['filter']['company']);$areasList = fetch_array($list_sql,'ID_area');if(isset($_POST['area'])) {    $area = $_POST['area'];}else if(isset($_SESSION['filter']['area'])){    $area = $_SESSION['filter']['area'];}else{    $area = 0;}$smarty->assign("area", $area);$smarty->assign("areaname", $areasList[$area]['area_name']);    if(isset($_POST['lamp'])) {        $lamp = $_POST['lamp'];    }    $smarty->assign("lamp", $lamp);if(isset($_POST['control'])) {    $control = $_POST['control'];}else if(isset($_SESSION['filter']['control'])){    $control = $_SESSION['filter']['control'];}else{    $control = 0;}$smarty->assign("control", $control);if(isset($_POST['defaultPlan'])) {    $defaultPlan = $_POST['defaultPlan'];}else{    $defaultPlan = 1;}$smarty->assign("defaultPlan", $defaultPlan);if(isset($_POST['plan'])) {    $plan = $_POST['plan'];}else{    $plan = 0;}$smarty->assign("plan", $plan);if(isset($_POST['is_enabled'])) {    $is_enabled = $_POST['is_enabled'];}else{    $is_enabled = 0;}$smarty->assign("is_enabled", $is_enabled);if(isset($_POST['set_workload'])) {    $set_workload = $_POST['set_workload'];}else{    $set_workload = 0;}$smarty->assign("set_workload", $set_workload);//choice controlif (isset($area)) {    $list_sql = query("    SELECT * FROM control_gateway WHERE area_ID_area =" . $area    );}$controlsList = fetch_array($list_sql,'ID_control');$smarty->assign("controlsList", $controlsList);}else{    go($setup['adm']['www'].'lamps/list.html');}?>