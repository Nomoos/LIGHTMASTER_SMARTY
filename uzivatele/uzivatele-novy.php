<?phpif ($_SESSION['user']['admin'] == '0') {    $whereOpravneni = " WHERE `admin`='0'";}$option['opravneni'] = fetch_array(query("SELECT `id`, `nazev` FROM `uzivatelOpravneni` {$whereOpravneni}"));$smarty->assign("option", $option);if ($_GET['dealer_id']) {    $dealer_id = intval($_GET['dealer_id']);    $dealer = fetch_assoc(query("SELECT `id`, `company` FROM `dealer` WHERE `id`='{$dealer_id}'"));    $msg = 'Vytvoření nového uživatele pro dealera "' . $dealer['company'] . '"';    $smarty->assign("msg", $msg);}if ($_POST['submitValue'] == 'new') {    if (!$_POST['login']) {        $err[] = "Není vyplněno přihlašovací jméno.";    }    if (!$_POST['password']) {        $err[] = "Není vyplněno heslo.";    }    if ($_POST['password'] != $_POST['password_again']) {        $err[] = "Hesla se neshodují.";    }    if (strlen($_POST['password']) < 4) {        $err[] = "Délka hesla musí být minimálně 4 znaky.";    }    if (!$_POST['jmeno']) {        $err[] = "Není vyplněno jméno.";    }    if (!$_POST['prijmeni']) {        $err[] = "Není vyplněno příjmení.";    }    if ($_POST['login']) {        $db_user = fetch_assoc(query("SELECT `login` FROM `uzivatel` WHERE `login` = '{$_POST['login']}'"));        if ($db_user) {            $err[] = "Uživatelské jméno - &bdquo;" . $_POST['login'] . "&rdquo; je již použito, zvolte jiné !";        }    }    if (!$_POST['uzivatelOpravneni_id']) {        $err[] = "Není vybráno oprávnění.";    }    if (!$err) {        $password = $_POST['password'];        $insert[] = "`login`='" . addslashes($_POST['login']) . "'";        $insert[] = "`jmeno`='" . addslashes($_POST['jmeno']) . "'";        $insert[] = "`prijmeni`='" . addslashes($_POST['prijmeni']) . "'";        $insert[] = "`nick`='" . addslashes($_POST['jmeno']) . " " . addslashes($_POST['prijmeni']) . "'";        $insert[] = "`email`='" . addslashes($_POST['email']) . "'";        $insert[] = "`uzivatelOpravneni_id`='" . intval($_POST['uzivatelOpravneni_id']) . "'";                query("START TRANSACTION");        if (!query("INSERT INTO `uzivatel` SET " . implode(",", $insert)))            $db_err[] = "Chyba při ukládání uživatele.";        $last_id = last_insert();        $heslo = sha1($last_id . $password);        if (!query("UPDATE `uzivatel` SET `password`='{$heslo}' WHERE `id`='{$last_id}'")) {            $db_err[] = "Chyba při ukládání hesla uživatele.";        }        if (!$db_err) {            query("COMMIT");            $go = $setup['adm']['www'] . "uzivatele/seznam.html";            go($go);        } else {            query("ROLLBACK");            $smarty->assign("db_err", $db_err);        }    } else {        $smarty->assign("err", $err);    }}?>